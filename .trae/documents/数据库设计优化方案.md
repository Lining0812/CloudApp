# 数据库设计优化方案

## 当前架构分析

### 核心实体
- **BaseEntity**：基础实体类，包含Id、CreatedAt、UpdatedAt、IsDeleted、DeletedAt
- **Album**：专辑实体，包含标题、描述、艺术家、发行日期、封面图片URL、单曲列表
- **Track**：单曲实体，包含标题、副标题、描述、时长、发行日期、艺术家、作曲者、作词者、封面图片、类型、专辑导航、演唱会导航
- **Concert**：演唱会实体，包含标题、描述、开始时间、结束时间、地址、封面图片URL、单曲列表
- **MediaResource**：媒体资源实体，包含文件名、文件路径、文件URL、MIME类型、资源类型、媒体关系列表
- **MediaRelation**：媒体关系实体，包含关联实体ID、实体类型、关联资源ID、资源类型、媒体资源导航

## 问题分析

1. **数据冗余**：Track表中同时存储了封面图片路径，而MediaResource已经存储了媒体资源信息
2. **关系设计**：Track同时关联Album和Concert，可能导致数据不一致
3. **索引缺失**：没有为常用查询字段添加索引
4. **类型设计**：某些字段类型可能不够优化
5. **软删除实现**：虽然实现了软删除，但可能需要更完善的处理
6. **媒体资源管理**：当前设计可能不够灵活

## 优化方案

### 1. 数据去重与结构优化
- **移除Track表中的CoverImage字段**，统一使用MediaRelation关联
- **优化Album和Concert的封面图片存储**，使用MediaRelation关联而非直接存储URL

### 2. 关系设计优化
- **明确Track与Album/Concert的关系**，确保数据一致性
- **增强MediaRelation设计**，添加优先级字段，支持多媒体资源关联

### 3. 索引优化
- **为常用查询字段添加索引**：
  - Track.Title、Track.Artist、Track.ReleaseDate
  - Album.Title、Album.Artist、Album.ReleaseDate
  - Concert.Title、Concert.StartAt
  - MediaRelation.EntityId、MediaRelation.EntityType、MediaRelation.MediaType

### 4. 类型与长度优化
- **优化字符串字段长度**：为Title、Artist等字段设置合理的最大长度
- **优化时间字段**：考虑使用DateTimeOffset存储时区信息

### 5. 软删除增强
- **为IsDeleted和DeletedAt字段添加索引**，提高软删除查询性能
- **添加软删除约束**，确保数据一致性

### 6. 媒体资源管理增强
- **为MediaResource添加文件大小字段**，便于管理
- **增强MediaRelation的关联能力**，支持更多实体类型

## 实施步骤

1. **修改实体类**：移除冗余字段，添加必要字段
2. **更新数据库配置**：添加索引，优化类型
3. **生成数据库迁移**：应用架构变更
4. **更新业务逻辑**：适配新的数据库设计
5. **测试验证**：确保所有功能正常运行

## 预期收益

- **减少数据冗余**：统一媒体资源管理，避免重复存储
- **提高查询性能**：通过索引优化，加速常用查询
- **增强数据一致性**：明确的关系设计，避免数据冲突
- **提升可维护性**：更清晰的数据库结构，便于后续开发
- **支持扩展性**：更灵活的媒体资源管理，支持未来需求